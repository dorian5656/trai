import{d as se,h as m,m as s,H as F,M as T,ab as U,k as I,z as k,j as _,y as oe,I as ge,f as u,w as ve,o as he,n as B,a4 as we,a0 as ye,u as Z,F as J,_ as O,C as be,p as Ce,r as h,c as G}from"./index-CshEJblI.js";import{af as ke,B as ne,r as $}from"./_plugin-vue_export-helper-DRBT_65h.js";import{M as _e,u as Ie,s as Re,H as X}from"./github-dark-C1pNfpAq.js";const g=[];for(let o=0;o<256;++o)g.push((o+256).toString(16).slice(1));function Se(o,r=0){return(g[o[r+0]]+g[o[r+1]]+g[o[r+2]]+g[o[r+3]]+"-"+g[o[r+4]]+g[o[r+5]]+"-"+g[o[r+6]]+g[o[r+7]]+"-"+g[o[r+8]]+g[o[r+9]]+"-"+g[o[r+10]]+g[o[r+11]]+g[o[r+12]]+g[o[r+13]]+g[o[r+14]]+g[o[r+15]]).toLowerCase()}let P;const $e=new Uint8Array(16);function xe(){if(!P){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");P=crypto.getRandomValues.bind(crypto)}return P($e)}const Me=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),ee={randomUUID:Me};function Te(o,r,d){o=o||{};const e=o.random??o.rng?.()??xe();if(e.length<16)throw new Error("Random bytes length must be >= 16");return e[6]=e[6]&15|64,e[8]=e[8]&63|128,Se(e)}function re(o,r,d){return ee.randomUUID&&!o?ee.randomUUID():Te(o)}const Ue=async o=>{const r={...o,submissionId:re()};return new Promise((d,e)=>{ke.post("/contact/lead",r).then(i=>{if(i instanceof Error){e(i);return}i&&typeof i=="object"&&"msg"in i?d({code:200,msg:i.msg||"提交成功",data:i.data||i}):d({code:200,msg:"提交成功",data:i||{id:0}})}).catch(i=>{if(i.response&&i.response.data){const{msg:y,code:b}=i.response.data;y&&y.includes("重复提交")?d({code:b||400,msg:y||"重复提交",data:{id:0}}):d({code:b||500,msg:y||"提交失败",data:{id:0}})}else e(i)})})},De={key:0,class:"form-body"},Le={class:"form-group"},Ee={key:0,class:"error-msg"},Fe={class:"form-group"},He={key:0,class:"error-msg"},Ve={class:"form-group"},Ae={key:0,class:"error-msg"},Be={class:"form-group"},Pe={key:0,class:"error-msg"},qe={class:"form-actions"},ze=["disabled"],Qe={key:1,class:"result-body"},je={key:0,class:"success-icon"},Ne={key:1,class:"error-icon"},Ke=se({__name:"ContactForm",emits:["close","submit"],setup(o,{emit:r}){const d=r,e=ge({show:!0,isSubmitting:!1,contact:{name:"",phone:"",product:"",region:""},errors:{name:"",phone:"",product:"",region:""},submitResult:{success:!1,message:"",showResult:!1}}),i=()=>{d("close")},y=()=>{let p=!0;const n=e.contact.name.trim();n?/^[\u4e00-\u9fa5a-zA-Z\s]{2,20}$/.test(n)?e.errors.name="":(e.errors.name="姓名请输入2-20个中英文字符",p=!1):(e.errors.name="请填写您的姓名",p=!1);const c=e.contact.phone.trim();return c?/^1[3-9]\d{9}$/.test(c)?e.errors.phone="":(e.errors.phone="请填写正确的11位手机号码",p=!1):(e.errors.phone="请填写您的联系电话",p=!1),e.contact.product.trim()?e.errors.product="":(e.errors.product="请填写您感兴趣的产品",p=!1),e.contact.region.trim()?e.errors.region="":(e.errors.region="请填写您所在的区域",p=!1),p},b=async()=>{if(!e.isSubmitting&&y()){e.isSubmitting=!0,e.submitResult.showResult=!1;try{const p=await Ue(e.contact);p.code===200?e.submitResult={success:!0,message:p.msg,showResult:!0}:e.submitResult={success:!1,message:p.msg,showResult:!0},p.code===200&&setTimeout(()=>{d("submit",e.contact)},1500)}catch(p){e.submitResult={success:!1,message:p.message||"网络异常，请重试",showResult:!0}}finally{e.isSubmitting=!1}}};return(p,n)=>e.show?(u(),m("div",{key:0,class:"contact-form-overlay",onClick:i},[s("div",{class:"contact-form-container",onClick:n[8]||(n[8]=oe(()=>{},["stop"]))},[s("div",{class:"form-header"},[n[9]||(n[9]=s("h3",null,"填写联系方式",-1)),s("span",{class:"close-btn",onClick:i},"×")]),e.submitResult.showResult?(u(),m("div",Qe,[e.submitResult.success?(u(),m("div",je,"✓")):(u(),m("div",Ne,"!")),s("h3",null,k(e.submitResult.success?"提交成功":"提交失败"),1),s("p",null,k(e.submitResult.message),1),s("button",{class:"close-result-btn",onClick:i},"关闭")])):(u(),m("div",De,[n[14]||(n[14]=s("p",{class:"form-desc"},"请留下您的联系方式，我们将安排专人为您服务",-1)),s("div",Le,[n[10]||(n[10]=s("label",null,[F("姓名 "),s("span",{class:"required"},"*")],-1)),T(s("input",{type:"text","onUpdate:modelValue":n[0]||(n[0]=c=>e.contact.name=c),placeholder:"请输入您的姓名",class:I({error:e.errors.name}),onInput:n[1]||(n[1]=c=>e.errors.name="")},null,34),[[U,e.contact.name]]),e.errors.name?(u(),m("span",Ee,k(e.errors.name),1)):_("",!0)]),s("div",Fe,[n[11]||(n[11]=s("label",null,[F("手机号码 "),s("span",{class:"required"},"*")],-1)),T(s("input",{type:"text","onUpdate:modelValue":n[2]||(n[2]=c=>e.contact.phone=c),placeholder:"请输入手机号码",class:I({error:e.errors.phone}),onInput:n[3]||(n[3]=c=>e.errors.phone=""),maxlength:"11"},null,34),[[U,e.contact.phone]]),e.errors.phone?(u(),m("span",He,k(e.errors.phone),1)):_("",!0)]),s("div",Ve,[n[12]||(n[12]=s("label",null,[F("感兴趣的产品 "),s("span",{class:"required"},"*")],-1)),T(s("input",{type:"text","onUpdate:modelValue":n[4]||(n[4]=c=>e.contact.product=c),placeholder:"例如：静脉留置针",class:I({error:e.errors.product}),onInput:n[5]||(n[5]=c=>e.errors.product="")},null,34),[[U,e.contact.product]]),e.errors.product?(u(),m("span",Ae,k(e.errors.product),1)):_("",!0)]),s("div",Be,[n[13]||(n[13]=s("label",null,[F("所在区域 "),s("span",{class:"required"},"*")],-1)),T(s("input",{type:"text","onUpdate:modelValue":n[6]||(n[6]=c=>e.contact.region=c),placeholder:"例如：河南省长垣市",class:I({error:e.errors.region}),onInput:n[7]||(n[7]=c=>e.errors.region="")},null,34),[[U,e.contact.region]]),e.errors.region?(u(),m("span",Pe,k(e.errors.region),1)):_("",!0)]),s("div",qe,[s("button",{class:"submit-btn",disabled:e.isSubmitting,onClick:b},k(e.isSubmitting?"提交中...":"立即提交"),9,ze)])]))])])):_("",!0)}}),We=ne(Ke,[["__scopeId","data-v-47bb011e"]]),te="/assets/smart-assistant-ChP_cCZM.png",Ye=async()=>{const o=["驼人集团最近有什么新产品上市?","驼人集团签约合作的医院有哪些?","想咨询掌超产品?怎么联系?","驼人医疗器械科技创新奖怎么报名?","驼人集团是做什么的?","我想经营驼人的产品应该怎么做?","驼人有没有(产品名称)?","驼人的公司地点在哪里?","我是(学校、专业等)有合适的岗位吗?","驼人有哪些岗位在招聘?"];return new Promise(r=>{r({code:200,data:o})})};function ae(o,r,d=365){let e="";if(d){const i=new Date;i.setTime(i.getTime()+d*24*60*60*1e3),e="; expires="+i.toUTCString()}document.cookie=o+"="+(r||"")+e+"; path=/"}function Ze(o){const r=o+"=",d=document.cookie.split(";");for(let e=0;e<d.length;e++){let i=d[e]||"";for(;i.charAt(0)==" ";)i=i.substring(1,i.length);if(i.indexOf(r)==0)return i.substring(r.length,i.length)}return null}const q="trai_user_id";async function Je(){let o=Ze(q);const r="未知";return o||(o=`user_${re().slice(0,8)}`,ae(q,o)),{userId:o,province:r}}function Oe(o){ae(q,o)}const Ge=async o=>(console.log("Mock submit customer info:",o),new Promise(r=>{setTimeout(()=>{r({success:!0,message:"提交成功 (Mock)"})},1e3)})),Xe={class:"chat-body"},et={key:0,class:"welcome-container"},tt={class:"chat-avatar-wrapper"},st=["src"],ot={class:"example-questions"},nt=["onClick"],rt={key:0,class:"ai-avatar"},at=["src"],it={class:"message-wrapper"},lt=["innerHTML"],ct={class:"chat-input-area"},ut=["disabled"],dt={key:0,width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor"},mt={key:1,width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor"},pt=se({__name:"SmartAssistant",props:{showChatDirectly:{type:Boolean,default:!0}},setup(o){const r=o,d=new _e({html:!0,linkify:!0,breaks:!0,highlight:function(l,t){if(t&&X.getLanguage(t))try{return'<pre class="hljs"><code>'+X.highlight(l,{language:t,ignoreIllegals:!0}).value+"</code></pre>"}catch{}return'<pre class="hljs"><code>'+d.utils.escapeHtml(l)+"</code></pre>"}}),e=d.renderer.rules.link_open||function(l,t,a,v,w){return w.renderToken(l,t,a)};d.renderer.rules.link_open=function(l,t,a,v,w){const f=l[t];return f.attrSet("target","_blank"),f.attrSet("rel","noopener noreferrer"),e(l,t,a,v,w)};const i=h(!1),y=h(""),b=h([]),p=h(!1),n=h(!1),c=h(!1),H=h(null),x=h(null),ie=h(null),z=h(null),R=h(!1),S=h(!1),Q=h([]),j=h([]),N=h(""),D=Ie(),le=G(()=>y.value.trim().length>0),V=G(()=>c.value&&D.abortController!==null);ve(R,l=>{window.parent!==window&&window.parent.postMessage({type:"setControlsVisibility",visible:!l},"*")});const ce=()=>`${Date.now()}-${Math.random().toString(36).slice(-6)}`,K=(l,t=!0)=>{if(!l)return"";try{let a=l;return t&&(a=l.replace(/\[点击留下\]\(contact\)/g,'<span class="leave-contact" style="cursor: pointer; color: #2473ba; text-decoration: underline;">点击留下</span>')),d.render(a)}catch{return l}},L=()=>B(()=>{x.value&&x.value.scrollTo({top:x.value.scrollHeight,behavior:"smooth"})}),W=l=>{if(b.value.length===0)return;const t=b.value[b.value.length-1];t&&(t.text=l,t.renderedText=K(l),L())},M=(l,t)=>{const a=ce();let v=K(t,!0);t.includes('<span class="leave-contact"')&&(v=v.replace(/<span class="leave-contact" style="cursor: pointer; color: #2473ba; text-decoration: underline;">点击留下<\/span>/g,`<span class="leave-contact" onclick="window.parent.postMessage({type:'openContactForm', source:'${a}'}, '*')">点击留下</span>`)),b.value.push({id:a,sender:l,text:t,renderedText:v}),L()},Y=async l=>{try{const t=await Ge(l);t.success?(R.value=!1,M("ai","感谢您的留资，我们将尽快与您联系。"),$.success("表单提交成功！")):$.error(t.message||"提交失败")}catch(t){console.error(t),$.error("提交失败，请稍后重试")}},ue=()=>{D.abortController&&(D.abortController.abort(),D.abortController=null,c.value=!1,n.value=!1,$.info("已停止生成"))},E=async l=>{const t=l.trim();if(!t||c.value)return;c.value=!0,n.value=!0,p.value=!0,M("user",t),y.value="",M("ai","正在思考......");const a=N.value||"guest_user";await Re({query:t,user:a,conversation_id:H.value||void 0,app_name:"guanwang",mode:"chat",inputs:{},isPublic:!0},(v,w)=>{n.value=!1,W(v),w&&(H.value=w)},()=>{c.value=!1,n.value=!1,b.value.filter(w=>w.sender==="user").length<=1&&setTimeout(()=>{M("ai","感谢您的咨询！如果您对我们的产品感兴趣，请[点击留下](contact)您的联系方式和感兴趣的产品/业务，我们将有专人与您联系。")},1e3)},v=>{console.error(v),c.value=!1,n.value=!1,W("网络异常，请稍后重试"),$.error("请求失败")})},de=l=>{const t=l.target;window.parent!==window&&window.parent.postMessage({type:"iframeClick",element:t.tagName,text:t.textContent,id:t.id},"*")},me=l=>{const t=l.currentTarget;if(!t)return;const{scrollTop:a,scrollHeight:v,clientHeight:w}=t,f=a+w>=v-1;l.deltaY>0&&f||l.deltaY<0},pe=()=>{S.value=!1,window.parent!==window&&window.parent.postMessage({type:"confirmClose"},"*")},fe=()=>{S.value=!1,R.value=!0},A=(l="")=>{R.value=!0};return he(async()=>{window!==window.top&&(document.documentElement.setAttribute("data-iframe","true"),console.log("[SmartAssistant] 检测到iframe环境，已应用iframe样式"));const{userId:t}=await Je();N.value=t,Oe(t);const a=await Ye();Q.value=a.data||[],j.value=[...Q.value].sort(()=>Math.random()-.5).slice(0,3),window.showCloseConfirmDialog=()=>{S.value=!0},window.openContactForm=()=>{A("消息链接")},window.showContactFormDialog=()=>{A("点击链接")},document.body.addEventListener("click",f=>{de(f);const C=f.target;(C.classList?.contains("leave-contact")||C.parentElement&&C.parentElement.classList?.contains("leave-contact"))&&(f.preventDefault(),f.stopPropagation(),A("点击链接"))}),window.addEventListener("message",f=>{if(f.data&&f.data.type){if(f.data.type==="showCloseConfirm"){S.value=!0;return}if(f.data.type==="formSubmitted"){const C=f.data.formData;C&&Y(C)}else if(f.data.type==="showSuccessMessage"){p.value=!0;const C=f.data.message||"感谢您的留资，我们将尽快与您联系。";M("ai",C),$.success("表单提交成功！")}}});const w=new URLSearchParams(window.location.search).get("question");w&&setTimeout(()=>{E(w)},500),window.addEventListener("resize",()=>{z.value&&r.showChatDirectly&&B(L)})}),we(()=>{window.openContactForm=void 0,window.showCloseConfirmDialog=void 0,window.showContactFormDialog=void 0}),ye(()=>{B(L)}),(l,t)=>(u(),m("div",null,[s("div",{class:I(["chat-window",{"is-maximized":i.value}]),ref_key:"chatWindowRef",ref:z},[t[12]||(t[12]=s("div",{class:"chat-header"},[s("div",{class:"header-icons"})],-1)),s("div",Xe,[p.value?(u(),m("div",{key:1,ref_key:"chatHistoryRef",ref:x,class:"chat-history",onWheel:me},[(u(!0),m(J,null,O(b.value,a=>(u(),m("div",{key:a.id,class:I(["message-row",`message-${a.sender}`])},[a.sender==="ai"?(u(),m("div",rt,[s("img",{src:Z(te),alt:"AI"},null,8,at)])):_("",!0),s("div",it,[s("div",{class:I(["message-content",{thinking:n.value&&a===b.value[b.value.length-1]&&a.sender==="ai"}]),innerHTML:a.renderedText},null,10,lt)])],2))),128))],544)):(u(),m("div",et,[s("div",tt,[s("img",{src:Z(te),alt:"AI助手",class:"chat-avatar-img"},null,8,st)]),t[7]||(t[7]=s("div",{class:"message-box"},[s("p",{class:"greeting"},"您好，我是智小驼 (测试版)"),s("p",{class:"intro"},"任何关于驼人集团的问题都可以问我，请在输入框输入您的问题。")],-1)),s("div",ot,[t[6]||(t[6]=s("p",{class:"title"},"您可以试着这样问：",-1)),(u(!0),m(J,null,O(j.value,(a,v)=>(u(),m("div",{key:v,onClick:w=>E(a),class:"question"},k(a),9,nt))),128))])])),s("div",ct,[T(s("input",{ref_key:"inputRef",ref:ie,"onUpdate:modelValue":t[0]||(t[0]=a=>y.value=a),onKeyup:t[1]||(t[1]=be(a=>E(y.value),["enter"])),placeholder:"请输入您的问题"},null,544),[[U,y.value]]),s("button",{onClick:t[2]||(t[2]=a=>V.value?ue():E(y.value)),disabled:!le.value&&!V.value},[V.value?(u(),m("svg",dt,[...t[8]||(t[8]=[s("path",{d:"M6 6h12v12H6z"},null,-1)])])):(u(),m("svg",mt,[...t[9]||(t[9]=[s("path",{d:"M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 9z"},null,-1)])]))],8,ut)]),t[10]||(t[10]=s("div",{class:"chat-footer"}," 内容由AI生成，仅供参考 ",-1))]),S.value?(u(),m("div",{key:0,class:"chat-confirm-overlay",onClick:t[4]||(t[4]=a=>S.value=!1)},[s("div",{class:"chat-confirm-dialog",onClick:t[3]||(t[3]=oe(()=>{},["stop"]))},[s("div",{class:"confirm-body"},[t[11]||(t[11]=s("p",null,"请留下您的联系方式和感兴趣的产品/业务，我们能更好地为您服务！",-1)),s("div",{class:"confirm-buttons"},[s("button",{onClick:fe,class:"confirm-btn"},"点击留资"),s("button",{onClick:pe,class:"cancel-btn"},"仍要关闭")])])])])):_("",!0)],2),R.value?(u(),Ce(We,{key:0,onClose:t[5]||(t[5]=a=>R.value=!1),onSubmit:Y})):_("",!0)]))}}),ht=ne(pt,[["__scopeId","data-v-de01a935"]]);export{ht as default};
