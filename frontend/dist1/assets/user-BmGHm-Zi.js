import{a9 as g,r as i,c as u}from"./index-DHyTAOuM.js";import{ad as c,y as b}from"./_plugin-vue_export-helper-EmPXxEAW.js";class m extends Error{constructor(t){super(t),this.name="ElementPlusError"}}function S(e,t){throw new m(`[${e}] ${t}`)}function A(e,t){}const l=e=>typeof Element>"u"?!1:e instanceof Element,v=e=>{if(e.tabIndex>0||e.tabIndex===0&&e.getAttribute("tabIndex")!==null)return!0;if(e.tabIndex<0||e.hasAttribute("disabled")||e.getAttribute("aria-disabled")==="true")return!1;switch(e.nodeName){case"A":return!!e.href&&e.rel!=="ignore";case"INPUT":return!(e.type==="hidden"||e.type==="file");case"BUTTON":case"SELECT":case"TEXTAREA":return!0;default:return!1}},T=(e,t)=>{if(!e||!e.focus)return;let a=!1;l(e)&&!v(e)&&!e.getAttribute("tabindex")&&(e.setAttribute("tabindex","-1"),a=!0),e.focus(t),l(e)&&a&&e.removeAttribute("tabindex")},h=e=>{const t=new URLSearchParams;return t.append("username",e.username),t.append("password",e.password),c.post("/auth/login",t,{headers:{"Content-Type":"application/x-www-form-urlencoded"}})},k=e=>c.post("/auth/register",e),w=()=>c.get("/users/me"),_=g("user",()=>{const e=i(localStorage.getItem("token")||""),t=i(null),a=u(()=>!!e.value),f=u(()=>t.value?.username||t.value?.full_name||"未登录"),d=u(()=>t.value?.avatar||""),p=async s=>{try{const r=await h(s);return e.value=r.access_token,localStorage.setItem("token",r.access_token),await o(),!0}catch(r){throw console.error("登录失败:",r),r}},o=async()=>{if(e.value)try{const s=await w();t.value=s}catch(s){console.error("获取用户信息失败, 尝试本地解析:",s);try{const r=e.value.split(".");if(r.length===3&&r[1]){const n=JSON.parse(atob(r[1]));n&&n.sub&&(t.value={id:"local",username:n.sub,full_name:n.sub,is_active:!0,is_superuser:!1,created_at:new Date().toISOString()})}}catch(r){console.error("Token 本地解析也失败:",r)}}};return{token:e,userInfo:t,isLoggedIn:a,username:f,avatar:d,login:p,logout:()=>{e.value="",t.value=null,localStorage.removeItem("token"),b.success("已退出登录")},fetchUserInfo:o,init:async()=>{e.value&&!t.value&&await o()}}});export{A as d,T as f,v as i,k as r,S as t,_ as u};
